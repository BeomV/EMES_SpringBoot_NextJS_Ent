<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.emes.core.domain.mapper.UserMapper">

    <!-- Result Map -->
    <resultMap id="UserResultMap" type="com.emes.core.domain.model.User">
        <id property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="email" column="email"/>
        <result property="displayName" column="display_name"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="department" column="department"/>
        <result property="position" column="position"/>
        <result property="enabled" column="enabled"/>
        <result property="accountLocked" column="account_locked"/>
        <result property="failedLoginAttempts" column="failed_login_attempts"/>
        <result property="lastLoginAt" column="last_login_at"/>
        <result property="passwordChangedAt" column="password_changed_at"/>
        <result property="createdBy" column="created_by"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedBy" column="updated_by"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deletedAt" column="deleted_at"/>
        <result property="version" column="version"/>
    </resultMap>

    <!-- Base Column -->
    <sql id="BaseColumns">
        user_id, username, password, email, display_name, phone_number, department, position,
        enabled, account_locked, failed_login_attempts, last_login_at, password_changed_at,
        created_by, created_at, updated_by, updated_at, deleted_at, version
    </sql>

    <!-- Select by ID -->
    <select id="selectById" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_CORE_USER
        WHERE user_id = #{userId}
          AND deleted_at IS NULL
    </select>

    <!-- Select by Username -->
    <select id="selectByUsername" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_CORE_USER
        WHERE username = #{username}
          AND deleted_at IS NULL
    </select>

    <!-- Select by Email -->
    <select id="selectByEmail" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_CORE_USER
        WHERE email = #{email}
          AND deleted_at IS NULL
    </select>

    <!-- Select All -->
    <select id="selectAll" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_CORE_USER
        WHERE deleted_at IS NULL
        ORDER BY created_at DESC
    </select>

    <!-- Select by Condition (페이징) -->
    <select id="selectByCondition" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_CORE_USER
        WHERE deleted_at IS NULL
        <if test="username != null and username != ''">
            AND username LIKE '%' + #{username} + '%'
        </if>
        <if test="email != null and email != ''">
            AND email LIKE '%' + #{email} + '%'
        </if>
        <if test="displayName != null and displayName != ''">
            AND display_name LIKE '%' + #{displayName} + '%'
        </if>
        <if test="department != null and department != ''">
            AND department LIKE '%' + #{department} + '%'
        </if>
        <if test="position != null and position != ''">
            AND position LIKE '%' + #{position} + '%'
        </if>
        <if test="enabled != null">
            AND enabled = #{enabled}
        </if>
        <if test="accountLocked != null">
            AND account_locked = #{accountLocked}
        </if>
        <choose>
            <when test="sortBy == 'username'">
                ORDER BY username ${sortDirection}
            </when>
            <when test="sortBy == 'email'">
                ORDER BY email ${sortDirection}
            </when>
            <when test="sortBy == 'displayName'">
                ORDER BY display_name ${sortDirection}
            </when>
            <when test="sortBy == 'department'">
                ORDER BY department ${sortDirection}
            </when>
            <otherwise>
                ORDER BY created_at ${sortDirection}
            </otherwise>
        </choose>
        OFFSET #{offset} ROWS
        FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- Count by Condition -->
    <select id="countByCondition" resultType="long">
        SELECT COUNT(*)
        FROM TB_CORE_USER
        WHERE deleted_at IS NULL
        <if test="username != null and username != ''">
            AND username LIKE '%' + #{username} + '%'
        </if>
        <if test="email != null and email != ''">
            AND email LIKE '%' + #{email} + '%'
        </if>
        <if test="displayName != null and displayName != ''">
            AND display_name LIKE '%' + #{displayName} + '%'
        </if>
        <if test="department != null and department != ''">
            AND department LIKE '%' + #{department} + '%'
        </if>
        <if test="position != null and position != ''">
            AND position LIKE '%' + #{position} + '%'
        </if>
        <if test="enabled != null">
            AND enabled = #{enabled}
        </if>
        <if test="accountLocked != null">
            AND account_locked = #{accountLocked}
        </if>
    </select>

    <!-- Insert -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO TB_CORE_USER (
            username, password, email, display_name, phone_number, department, position,
            enabled, account_locked, failed_login_attempts, password_changed_at,
            created_by, created_at, version
        ) VALUES (
            #{username}, #{password}, #{email}, #{displayName}, #{phoneNumber}, #{department}, #{position},
            #{enabled}, #{accountLocked}, 0, #{passwordChangedAt},
            #{createdBy}, #{createdAt}, 0
        )
    </insert>

    <!-- Update -->
    <update id="update">
        UPDATE TB_CORE_USER
        <set>
            <if test="email != null">email = #{email},</if>
            <if test="displayName != null">display_name = #{displayName},</if>
            <if test="phoneNumber != null">phone_number = #{phoneNumber},</if>
            <if test="department != null">department = #{department},</if>
            <if test="position != null">position = #{position},</if>
            <if test="enabled != null">enabled = #{enabled},</if>
            <if test="accountLocked != null">account_locked = #{accountLocked},</if>
            <if test="updatedBy != null">updated_by = #{updatedBy},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
            version = version + 1
        </set>
        WHERE user_id = #{userId}
          AND deleted_at IS NULL
    </update>

    <!-- Soft Delete -->
    <update id="softDelete">
        UPDATE TB_CORE_USER
        SET deleted_at = #{deletedAt}
        WHERE user_id = #{userId}
    </update>

    <!-- Hard Delete -->
    <delete id="delete">
        DELETE FROM TB_CORE_USER
        WHERE user_id = #{userId}
    </delete>

    <!-- Increment Failed Login Attempts -->
    <update id="incrementFailedLoginAttempts">
        UPDATE TB_CORE_USER
        SET failed_login_attempts = failed_login_attempts + 1
        WHERE user_id = #{userId}
    </update>

    <!-- Reset Failed Login Attempts -->
    <update id="resetFailedLoginAttempts">
        UPDATE TB_CORE_USER
        SET failed_login_attempts = 0,
            last_login_at = GETDATE()
        WHERE user_id = #{userId}
    </update>

    <!-- Lock Account -->
    <update id="lockAccount">
        UPDATE TB_CORE_USER
        SET account_locked = 1
        WHERE user_id = #{userId}
    </update>

    <!-- Unlock Account -->
    <update id="unlockAccount">
        UPDATE TB_CORE_USER
        SET account_locked = 0,
            failed_login_attempts = 0
        WHERE user_id = #{userId}
    </update>

    <!-- Update Password -->
    <update id="updatePassword">
        UPDATE TB_CORE_USER
        SET password = #{password},
            password_changed_at = #{passwordChangedAt}
        WHERE user_id = #{userId}
    </update>

</mapper>
